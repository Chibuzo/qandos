extends ../dashboard-layout 

block content
    .card.bg-light-info.shadow-none.position-relative.overflow-hidden
        .card-body.px-4.py-3
            .row.align-items-center
                .col-9
                    h4.fw-semibold.mb-8 Edit Property
                    nav(aria-label='breadcrumb')
                        ol.breadcrumb
                            li.breadcrumb-item
                                a(href='#') Home
                            li.breadcrumb-item
                                a(href='/property/list') Properties
                            li.breadcrumb-item(aria-current='page') Edit
                .col-3
                    .text-center.mb-n5

    .row 
        .col-md-12
            .card.w-100.position-relative.overflow-hidden
                .card-body.p-4
                    h4.fw-semibold.mb-4 Property Details 

                    form(action=`/property/${property.id}/update` method='post')
                        // Public visibility note
                        .alert.alert-info Only Size, Price, Location, Asset Class and Pictures & Videos will be publicly visible.

                        // Section A: Basic Property Details
                        h5.mb-3 Basic Property Details
                        .form-group.mb-3
                            label.form-label Property Title/Name
                            input.form-control(name="title" type="text" value=property.title required placeholder="e.g., 500sqm Plot in Jahi")

                        .form-group.mb-3
                            label.form-label Location / District
                            select.form-control(name="district" required)
                                option(value='') -- Select District --
                                each dist in ['Guzape', 'Maitama', 'Wuse II', 'Wuse I', 'Jahi', 'Gwarinpa', 'Asokoro', 'Kubwa', 'Bwari']
                                    option(value=dist selected=(property.district === dist))= dist

                        .form-group.mb-3.row
                            .col-md-6
                                label.form-label Asset Class
                                select.form-control(name="asset_class" required)
                                    option(value='') -- Select Asset Class --
                                    each ac in ['Residential', 'Commercial', 'Mixed-Use']
                                        option(value=ac selected=(property.asset_class === ac))= ac
                            .col-md-6
                                label.form-label Asking Price (â‚¦)
                                input.form-control(name="price" type='text' value=view.formatCurrency(property.cost) required placeholder='e.g., 25,000,000')

                        .form-group.mb-3
                            label.form-label Role
                            select.form-control(name="role" required)
                                option(value='') -- Select Role --
                                option(value='Owner' selected=(property.role === 'Owner')) Owner
                                option(value='Agent' selected=(property.role === 'Agent')) Agent

                        .form-group.mb-3
                            label.form-label Size
                            input.form-control(name="plot_size" type='text' value=property.plot_size placeholder='e.g., 500 sqm')

                        if admin
                            .form-group.mb-4
                                label.form-label Featured
                                select.form-control#featured(name="featured")  
                                    option(value='0' selected=(property.featured == '0')) No
                                    option(value='1' selected=(property.featured == '1')) Yes

                        // Section B: Legal & Technical (Required for Verification)
                        h5.mt-4.mb-3 Legal & Technical (Required for Verification)
                        .form-group.mb-3
                            label.form-label Title Document Type
                            select.form-control(name="title_document_type")
                                option(value='') -- Select Document Type --
                                each docType in ['C of O', 'R of O', 'Deed of Assignment', 'Court Judgment']
                                    option(value=docType selected=(property.title_document_type === docType))= docType

                        .form-group.mb-3
                            label.form-label Plot Number
                            input.form-control(name="plot_number" type='text' value=property.plot_number required placeholder='Critical for AGIS check')

                        .form-group.mb-3
                            label.form-label Name of Allottee/Owner (as on document)
                            input.form-control(name="allottee_name" type='text' value=property.allottee_name required)

                        .form-group.mb-3
                            label.form-label Survey Coordinates / Beacon Numbers
                            input.form-control(name="survey_coordinates" type='text' value=property.survey_coordinates placeholder='GPS coords or beacon refs')

                        // Section D: Agent/Owner Identity
                        h5.mt-4.mb-3 Agent / Owner Identity
                        .form-group.mb-3
                            label.form-label NIN or RC Number
                            input.form-control(name='nin_rc' type='text' value=property.nin_rc required placeholder='NIN or RC number for verification')

                        .form-group.mb-3.form-check
                            input.form-check-input(type='checkbox' id='listing_consent' name='listing_consent' checked=property.listing_consent required)
                            label.form-check-label(for='listing_consent') I confirm that I have the legal right to list this property and that QANDOS will conduct a mandatory audit upon buyer interest.

                        .mb-3
                            button.btn.btn-primary.float-end.ms-3(type='submit') Update Property
                            a.btn.btn-light.float-end(href=`/property/list`) Cancel

    .row.mt-4
        .col-md-4 
            .card.w-100.position-relative.overflow-hidden
                .card-body.p-4
                    h4.fw-semibold.mb-4 Title Document Scan
                    if photos.length
                        each photo in photos
                            if photo.mediaType == 'document'
                                .mb-3
                                    a(href=`/${photo.location}` target='_blank') View Document
                                    .btn.btn-sm.btn-danger.delete-media.ms-2(id=`${photo.id}`) Delete
                    
                    form(method='post' enctype="multipart/form-data" action=`/property/${property.id}/upload-photos`)#form-doc
                        input.form-control.d-none#input-doc-upload(type='file' name='property_photos')
                        input(type='hidden' name='mediaType' value='document')
                        button.btn.btn-outline-primary.mt-2#btn-upload-doc(type='button') Upload Document

        .col-md-4 
            .card.w-100.position-relative.overflow-hidden
                .card-body.p-4
                    h4.fw-semibold.mb-4 Property Photos 
                    if photos.length
                        .photos.row
                            each photo in photos
                                if photo.mediaType == 'photo'
                                    .col-md-6.mb-3
                                        .photo(style=`background-image:url(/${photo.location})`)
                                            .btn.btn-sm.btn-danger.delete-media(id=`${photo.id}`) Delete

                    form(method='post' enctype="multipart/form-data" action=`/property/${property.id}/upload-photos`)#form-photos
                        input.form-control.d-none#input-property-upload(type='file' multiple name='property_photos')
                        input(type='hidden' name='mediaType' value='photo')
                        button.btn.btn-outline-primary.mt-2#btn-upload-photo(type='button') Upload Photos

        .col-md-4
            .card.w-100.position-relative.overflow-hidden
                .card-body.p-4
                    h4.fw-semibold.mb-4 Video Tour 
                    if photos.length
                        each photo in photos
                            if photo.mediaType == 'video'
                                .video.mb-3
                                    video(width='100%' controls)
                                        source(src=`/${photo.location}` type='video/mp4')
                                    .btn.btn-sm.btn-danger.delete-media.mt-2(id=`${photo.id}`) Delete

                    form(method='post' enctype="multipart/form-data" action=`/property/${property.id}/upload-photos`)#form-video
                        input.form-control.d-none#input-video-upload(type='file' name='property_photos')
                        input(type='hidden' name='mediaType' value='video')
                        button.btn.btn-outline-primary.mt-2#btn-upload-video(type='button') Upload Video

block scriptBlock 
    script.

        const btnUploadDoc = document.getElementById("btn-upload-doc");
        const btnUploadPhoto = document.getElementById("btn-upload-photo");
        const btnUploadVideo = document.getElementById("btn-upload-video");

        if(btnUploadDoc){
            btnUploadDoc.addEventListener('click', function() {
                document.getElementById("input-doc-upload").click();
            });
            document.getElementById("input-doc-upload").addEventListener('change', function() {
                document.getElementById("form-doc").submit();
            });
        }

        if(btnUploadPhoto){
            btnUploadPhoto.addEventListener('click', function() {
                document.getElementById("input-property-upload").click();
            });
            document.getElementById("input-property-upload").addEventListener('change', function() {
                document.getElementById("form-photos").submit();
            });
        }

        if(btnUploadVideo){
            btnUploadVideo.addEventListener('click', function() {
                document.getElementById("input-video-upload").click();
            });
            document.getElementById("input-video-upload").addEventListener('change', function() {
                document.getElementById("form-video").submit();
            });
        }

        // delete media
        const btnDelete = document.querySelectorAll('.delete-media');
        btnDelete.forEach(btn => {
            btn.addEventListener('click', async function() {
                if(confirm('Are you sure you want to delete this file?')) {
                    const id = this.id;
                    await fetch('/delete-media?id=' + id);
                    location.reload();  
                }
            });
        });
