extends ../admin/layout 

block content
    .card.bg-light-info.shadow-none.position-relative.overflow-hidden
        .card-body.px-4.py-3
            .row.align-items-center
                .col-9
                    h4.fw-semibold.mb-8 Edit Property
                    nav(aria-label='breadcrumb')
                        ol.breadcrumb
                            li.breadcrumb-item
                                a(href='#') Home
                            li.breadcrumb-item
                                a(href='/property/list') Properties
                            li.breadcrumb-item(aria-current='page') Edit
                .col-3
                    .text-center.mb-n5

    .row 
        .col-md-7
            .card.w-100.position-relative.overflow-hidden
                .card-body.p-4
                    h4.fw-semibold.mb-4 Property Details 

                    form(action=`/property/${property.id}/update` method='post')
                        .form-group.mb-3
                            label.form-label Property Title 
                            input.form-control(name="title" value=`${property.title}` type="text" required)
                        .form-group.mb-3 
                            label.form-label Description
                            textarea.form-control(name="description" type="text")
                                | #{property.description}

                        .form-group.mb-3.row
                            .col-md-6
                                label.form-label Category 
                                select.form-control#category(name="category" required)  
                                    option(value='') -- Category --
                                    option(value='fully built') Fully built 
                                    option(value='land') Land
                                    option(value='uncompleted') Uncompleted
                            .col-md-6
                                label.form-label Currently Occupied 
                                select.form-control(name="occupied")  
                                    option(value='0') No 
                                    option(value='1') Yes

                        .form-group.mb-3.row 
                            .col-md-6
                                label.form-label Bedrooms 
                                select.form-control#bedroom(name="bedrooms")  
                                    option(value='') -- No of Bedrooms --
                                    option(value='1') 1 
                                    option(value='2') 2
                                    option(value='3') 3
                                    option(value='4') 4
                                    option(value='5') 5
                                    option(value='6') 6
                                    option(value='7') 7
                            .col-md-6
                                label.form-label Toilets 
                                select.form-control#toilet(name="toilets")  
                                    option(value='') -- No of Toilets --
                                    option(value='1') 1 
                                    option(value='2') 2
                                    option(value='3') 3
                                    option(value='4') 4
                                    option(value='5') 5
                                    option(value='6') 6
                                    option(value='7') 7

                        .form-group.mb-3.row
                            .col-md-6
                                label.form-label Age (months)
                                input.form-control(name="age" value=`${property.age}` type='number' )  

                            .col-md-6
                                label.form-label Asking Price 
                                input.form-control(name="cost" value=`${property.cost}` type='text' required)  

                        .form-group.mb-4.row
                            .col-md-6
                                label.form-label State 
                                select.form-control#state(name="state" required)  
                                    option(value='') -- State --
                                    each state in states 
                                        if property.state == state.slug
                                            option(value=`${state.slug}` selected)= state.name
                                        else 
                                            option(value=`${state.slug}`)= state.name

                            .col-md-6
                                label.form-label City 
                                select.form-control#city(name="city" required)  
                                    option(value='') -- City --
                                    each city in cities 
                                        if property.city == city
                                            option(value=`${city}` selected)= city
                                        else 
                                            option(value=`${city}`)= city
                        .form-group.mb-4.row
                            .col-md-6
                                label.form-label Available Units 
                                input.form-control(type='number' value=`${property.available_units}` name="available_units" required)  
                            .col-md-6
                                label.form-label Plot Size 
                                input.form-control(name="plot_size" type='text' value=`${property.plot_size || ''}`)  

                        .form-group.mb-4.row
                            .col-md-6
                                label.form-label Closest Landmark 
                                input.form-control(type='text' name="closest_landmark" value=`${property.closest_landmark || ''}`)  
                            .col-md-6
                                label.form-label Garage/Parking Space
                                input.form-control(name="garage" type='text' value=`${property.garage || ''}`)  

                        .form-group.mb-4.row
                            .col-md-6
                                label.form-label Longitude
                                input.form-control(type='text' name="longitude" value=`${property.longitude || ''}`)  
                            .col-md-6
                                label.form-label Latitude 
                                input.form-control(name="latitude" type='text' value=`${property.latitude || ''}`)  

                        .form-group.mb-4.row
                            .col-md-6
                                label.form-label Featured
                                select.form-control#featured(name="featured")  
                                    option(value='') -- Featured --
                                    if property.featured == true
                                        option(value='1' selected) Yes
                                        option(value='0') No
                                    else if property.featured == false
                                        option(value='0' selected) No
                                        option(value='1') Yes
                                    else 
                                        option(value='0') No
                                        option(value='1') Yes

                        .mb-3 
                            button.btn.btn-primary.float-end.ms-3(type='submit') Save Property
                            a.btn.btn-light.float-end(href=`/property/list`) Cancel


        .col-md-5 
            .card.w-100.position-relative.overflow-hidden
                .card-body.p-4
                    h4.fw-semibold.mb-4 Property Photos 

                    if photos.length
                        .photos.row
                            each photo in photos
                                if photo.mediaType == 'photo'
                                    .col-md-6.mb-3
                                        .photo(style=`background-image:url(/${photo.location})`)
                                            .btn.btn-sm.btn-danger.delete-media(id=`${photo.id}`) Delete

                    form(method='post' enctype="multipart/form-data" action=`/property/${property.id}/upload-photos`)#form-photos
                        input.form-control.d-none#input-property-upload(type='file' multiple name='property_photos')
                        input(type='hidden' name='mediaType' value='photo')

                        button.btn.btn-primary.mt-5#btn-upload-photo(type='button') Upload Photos

            .card.w-100.position-relative.overflow-hidden
                .card-body.p-4
                    h4.fw-semibold.mb-4 Video Tour 

                    if photos.length
                        .photos.row
                            each photo in photos
                                if photo.mediaType == 'video'
                                    .col-md-6.mb-3
                                        .video
                                            video(width='250' controls)
                                                source(src=`/${photo.location}` type='video/mp4')

                                            .btn.btn-sm.btn-danger.delete-media(id=`${photo.id}`) Delete


                    form(method='post' enctype="multipart/form-data" action=`/property/${property.id}/upload-photos`)#form-video
                        input.form-control.d-none#input-video-upload(type='file' multiple name='property_photos')
                        input(type='hidden' name='mediaType' value='video')

                        button.btn.btn-primary.mt-5#btn-upload-video(type='button') Upload Videos

            .card.w-100.position-relative.overflow-hidden
                .card-body.p-4
                    h4.fw-semibold.mb-4 Floor Plans

                    if photos.length
                        .photos.row
                            each photo in photos
                                if photo.mediaType == 'floor plan'
                                    .col-md-6.mb-3
                                        .photo(style=`background-image:url(/${photo.location})`)
                                            .btn.btn-sm.btn-danger.delete-media(id=`${photo.id}`) Delete


                    form(method='post' enctype="multipart/form-data" action=`/property/${property.id}/upload-photos`)#form-floor
                        input.form-control.d-none#input-floor-upload(type='file' multiple name='property_photos')
                        input(type='hidden' name='mediaType' value='floor plan')

                        button.btn.btn-primary.mt-5#btn-upload-floor(type='button') Upload Floor Plans


block scriptBlock 
    script.

        const btnUploadPhoto = document.getElementById("btn-upload-photo");
        const btnVideoPhoto = document.getElementById("btn-upload-video");
        const btnFloorPhoto = document.getElementById("btn-upload-floor");

        // handle photos
        btnUploadPhoto.addEventListener('click', function() {
            document.getElementById("input-property-upload").click();
        });

        document.getElementById("input-property-upload").addEventListener('change', function() {
            document.getElementById("form-photos").submit();
        });

        // handle video
        btnVideoPhoto.addEventListener('click', function() {
            document.getElementById("input-video-upload").click();
        });

        document.getElementById("input-video-upload").addEventListener('change', function() {
            document.getElementById("form-video").submit();
        });

        // handle floor
        btnFloorPhoto.addEventListener('click', function() {
            document.getElementById("input-floor-upload").click();
        });

        document.getElementById("input-floor-upload").addEventListener('change', function() {
            document.getElementById("form-floor").submit();
        });

        const category = !{JSON.stringify(property.category)};
        document.getElementById('category').value = category;

        const bedroom = !{JSON.stringify(property.bedrooms)};
        document.getElementById('bedroom').value = bedroom;

        const toilet = !{JSON.stringify(property.toilets)};
        document.getElementById('toilet').value = toilet;

        let state;
        document.getElementById('state').addEventListener('change', async function() {
            state = this.value;
            const resp = await fetch('/cities?state=' + state);
            const cities = await resp.json();
            let opts = "<option value=''>-- City --</option>";
            opts += cities.data.cities.map(city => `<option value=${city}>${city}</option>`);
            document.getElementById('city').innerHTML = opts;
        });

        //- const featured = !{JSON.stringify(property.featured)};
        //- document.getElementById('featured').value = featured.toString();

        // delete media
        const btnDelete = document.getElementsByClassName('delete-media');

        btnDelete.forEach(btn => {
            btn.addEventListener('click', async function() {
                if(confirm('Are you sure you want to delete this file?')) {
                    const id = this.id;
                    await fetch('/delete-media?id=' + id);
                    location.reload();  
                }
            });
        });
