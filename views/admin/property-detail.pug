extends ../dashboard-layout

block content
    .card.bg-light-info.shadow-none.position-relative.overflow-hidden
        .card-body.px-4.py-3
            .row.align-items-center
                .col-9
                    h4.fw-semibold.mb-8 Property Details
                    nav(aria-label='breadcrumb')
                        ol.breadcrumb
                            li.breadcrumb-item
                                a.text-muted(href='/admin/dashboard') Home
                            li.breadcrumb-item
                                a.text-muted(href='/admin/agent-properties') Agent Properties
                            li.breadcrumb-item(aria-current='page') Details
                .col-3
                    .text-center.mb-n5

    .row
        .col-md-8
            .card.w-100.position-relative.overflow-hidden
                .card-body.p-4
                    h5.mb-3 Basic Information
                    .row.mb-3
                        .col-md-6
                            strong Title: 
                            span= property.title
                        .col-md-6
                            strong Price: 
                            span â‚¦#{view.formatCurrency(property.cost)}
                    .row.mb-3
                        .col-md-6
                            strong Location: 
                            span #{property.district}
                        .col-md-6
                            strong Asset Class: 
                            span= property.asset_class
                    .row.mb-3
                        .col-md-6
                            strong Size: 
                            span= property.plot_size
                        .col-md-6
                            strong Status: 
                            span.badge(class=`${property.status === 'available' ? 'bg-success' : property.status === 'unverified' ? 'bg-warning' : 'bg-danger'}`) #{property.status}
                    
                    if property.rejection_reason
                        .alert.alert-danger
                            strong Rejection Reason: 
                            span= property.rejection_reason

                    hr.my-4

                    h5.mb-3 Legal & Technical Details
                    .row.mb-3
                        .col-md-6
                            strong Title Document Type: 
                            span= property.title_document_type
                        .col-md-6
                            strong Plot Number: 
                            span= property.plot_number
                    .row.mb-3
                        .col-md-6
                            strong Allottee Name: 
                            span= property.allottee_name
                        .col-md-6
                            strong Survey Coordinates: 
                            span= property.survey_coordinates
                    
                    hr.my-4

                    h5.mb-3 Agent / Owner Identity
                    .row.mb-3
                        .col-md-6
                            strong Added By: 
                            span #{property.User ? property.User.fullname : 'Unknown'} (#{property.User ? property.User.role : 'N/A'})
                        .col-md-6
                            strong NIN / RC Number: 
                            span= property.nin_rc
                    .mt-3
                        if property.listing_consent
                            span.badge.bg-success Consent Given
                        else
                            span.badge.bg-danger No Consent Record

        .col-md-4
            .card.w-100.position-relative.overflow-hidden
                .card-body.p-4
                    h5.mb-3 Actions
                    .d-grid.gap-2
                        if property.status !== 'available'
                            button.btn.btn-success(onclick=`updateStatus('${property.id}', 'available')`) Approve Property
                        
                        if property.status !== 'rejected'
                            button.btn.btn-danger(data-bs-toggle="modal" data-bs-target="#rejectModal") Reject Property

    .row
        .col-12
            .card
                .card-body
                    h5.mb-4 Media Gallery
                    ul.nav.nav-tabs#myTab(role="tablist")
                        li.nav-item(role="presentation")
                            button.nav-link.active#photos-tab(data-bs-toggle="tab" data-bs-target="#photos" type="button" role="tab") Photos
                        li.nav-item(role="presentation")
                            button.nav-link#videos-tab(data-bs-toggle="tab" data-bs-target="#videos" type="button" role="tab") Videos
                        li.nav-item(role="presentation")
                            button.nav-link#docs-tab(data-bs-toggle="tab" data-bs-target="#docs" type="button" role="tab") Documents
                    
                    .tab-content.p-3#myTabContent
                        // Photos Tab
                        .tab-pane.fade.show.active#photos(role="tabpanel")
                            .row
                                if photos.filter(p => p.mediaType === 'photo').length > 0
                                    each photo in photos
                                        if photo.mediaType === 'photo'
                                            .col-md-3.mb-3
                                                a(href=`/${photo.location}` target="_blank")
                                                    img.img-fluid.rounded(src=`/${photo.location}` alt="Property Photo")
                                else
                                    .col-12: p.text-muted No photos available.

                        // Videos Tab
                        .tab-pane.fade#videos(role="tabpanel")
                            .row
                                if photos.filter(p => p.mediaType === 'video').length > 0
                                    each video in photos
                                        if video.mediaType === 'video'
                                            .col-md-4.mb-3
                                                video.w-100(controls)
                                                    source(src=`/${video.location}` type="video/mp4")
                                else
                                    .col-12: p.text-muted No videos available.

                        // Documents Tab
                        .tab-pane.fade#docs(role="tabpanel")
                            .row
                                if photos.filter(p => p.mediaType === 'document').length > 0
                                    each doc in photos
                                        if doc.mediaType === 'document'
                                            .col-md-4.mb-3
                                                .card.border
                                                    .card-body.d-flex.align-items-center
                                                        i.ti.ti-file-text.fs-6.me-2
                                                        a(href=`/${doc.location}` target="_blank") View Document
                                else
                                    .col-12: p.text-muted No documents available.

    // Reject Modal
    .modal.fade#rejectModal(tabindex="-1" aria-hidden="true")
        .modal-dialog
            .modal-content
                .modal-header
                    h5.modal-title Reject Property
                    button.btn-close(type="button" data-bs-dismiss="modal" aria-label="Close")
                .modal-body
                    form#rejectForm
                        .mb-3
                            label.form-label(for="rejectionReason") Reason for Rejection
                            textarea.form-control#rejectionReason(rows="3" required)
                        input(type="hidden" id="rejectPropertyId" value=property.id)
                .modal-footer
                    button.btn.btn-secondary(type="button" data-bs-dismiss="modal") Cancel
                    button.btn.btn-danger(type="button" onclick="submitRejection()") Reject Property

block scriptBlock
    script.
        async function updateStatus(propertyId, status) {
            if (confirm(`Are you sure you want to mark this property as ${status}?`)) {
                try {
                    const res = await fetch('/admin/update-property-status', {
                        method: 'POST',
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ propertyId, status })
                    });
                    const data = await res.json();
                    if (data.status === 'success') {
                        location.reload();
                    } else {
                        alert('Error updating status');
                    }
                } catch (err) {
                    console.error(err);
                    alert('An error occurred');
                }
            }
        }

        async function submitRejection() {
            const propertyId = document.getElementById('rejectPropertyId').value;
            const reason = document.getElementById('rejectionReason').value;

            if (!reason) {
                alert('Please provide a reason for rejection.');
                return;
            }

            try {
                const res = await fetch('/admin/reject-property', {
                    method: 'POST',
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ propertyId, reason })
                });
                const data = await res.json();
                if (data.status === 'success') {
                    location.reload();
                } else {
                    alert('Error rejecting property');
                }
            } catch (err) {
                console.error(err);
                alert('An error occurred');
            }
        }
