extends ../dashboard-layout

block content
    .card.bg-light-info.shadow-none.position-relative.overflow-hidden
        .card-body.px-4.py-3
            .row.align-items-center
                .col-9
                    h4.fw-semibold.mb-8 Agent Properties
                    nav(aria-label='breadcrumb')
                        ol.breadcrumb
                            li.breadcrumb-item
                                a.text-muted(href='/admin/dashboard') Home
                            li.breadcrumb-item(aria-current='page') Agent Properties
    .card.w-100.position-relative.overflow-hidden
        .px-4.py-3.border-bottom
            .card-title.fw-semibold.mb-0.lh-sm Properties by Partners/Agents
        .card-body.p-4
            .table-responsive.rounded-2.mb-4
                table.table
                    thead
                        tr
                            th Date
                            th Title
                            th Owner (Role)
                            th District
                            th Cost 
                            th Status
                            th Action
                    tbody
                        each property in properties 
                            tr 
                                td= view.formatDate(property.createdAt)
                                td= property.title
                                td #{property.User ? property.User.fullname : 'Unknown'} (#{property.User ? property.User.role : 'N/A'})
                                td #{property.district} 
                                td N #{view.formatCurrency(property.cost)}
                                td
                                    span.badge(class=`${property.status === 'available' ? 'bg-light-success text-success' : property.status === 'unverified' ? 'bg-light-warning text-warning' : 'bg-light-danger text-danger'}`)
                                        | #{property.status}
                                td
                                    if property.status === 'unverified'
                                        a(href='#' onClick=`updateStatus('${property.id}', 'available')` title='Approve/Verify').me-2
                                            span(style='font-size: 16px')    
                                                i.ti.ti-check
                                    
                                    if property.status !== 'sold'
                                        a(href=`#` onClick=`updateStatus('${property.id}', 'sold')` title='Mark as Sold').me-2
                                            span(style='font-size: 16px')
                                                i.ti.ti-shopping-cart
                                    
                                    a(href=`/property/${property.id}/edit` title='Edit').me-2
                                        span(style='font-size: 16px')    
                                            i.ti.ti-pencil

block scriptBlock 
    script.
        async function updateStatus(propertyId, status) {
            if (confirm(`Are you sure you want to mark this property as ${status}?`)) {
                const res = await fetch('/admin/update-property-status', {
                    method: 'POST',
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({ propertyId, status })
                });
                const data = await res.json();
                if (data.status === 'success') {
                    location.reload();
                } else {
                    alert('Error updating status');
                }
            }
        }
